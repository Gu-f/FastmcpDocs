---
title: 测试您的服务器
sidebarTitle: 测试
description: 使用 FastMCP Client 的确定性测试功能对您的 MCP 服务器进行单元测试
icon: vial
---

[FastMCP Client](/zh/clients/client) 是一个确定性测试工具，为您提供对 MCP 服务器交互的完全程序化控制。您可以使用精确参数调用特定工具、验证响应并测试边缘情况 - 这使其成为对 MCP 服务器进行单元测试的理想选择。

## 内存测试

FastMCP Client 的突出特性是内存测试。您不需要部署服务器或管理网络连接，而是直接将服务器实例传递给客户端。这创建了一个完全在内存中运行的零开销连接。

这种方法如此强大的原因是一切都在同一个 Python 进程中运行。您可以在任何地方设置断点 - 在测试代码中或服务器处理程序内 - 并使用调试器单步执行。没有服务器启动脚本、没有端口管理、没有测试间的清理工作。测试立即执行，没有网络开销。

```python
from fastmcp import FastMCP, Client

# 创建您的服务器
server = FastMCP("WeatherServer")

@server.tool
def get_temperature(city: str) -> dict:
    """获取城市的当前温度"""
    temps = {"NYC": 72, "LA": 85, "Chicago": 68}
    return {"city": city, "temp": temps.get(city, 70)}

@server.resource("weather://forecast")
def get_forecast() -> dict:
    """获取 5 天天气预报"""
    return {"days": 5, "conditions": "sunny"}

async def test_weather_operations():
    # 直接传递服务器 - 不需要部署
    async with Client(server) as client:
        # 测试工具执行
        result = await client.call_tool("get_temperature", {"city": "NYC"})
        assert result.data == {"city": "NYC", "temp": 72}
        
        # 测试资源检索
        forecast = await client.read_resource("weather://forecast")
        assert forecast.contents[0].data == {"days": 5, "conditions": "sunny"}
```

内存方法将 MCP 测试从部署挑战转变为标准单元测试。您可以专注于测试服务器的行为，而不是与基础设施作斗争。

## 使用框架进行测试

FastMCP Client 与任何 Python 测试框架无缝配合。无论您偶好 pytest、unittest 还是其他框架，模式都是一致的：创建服务器、将其传递给客户端并验证行为。

```python
import pytest
from fastmcp import FastMCP, Client

@pytest.fixture
def weather_server():
    server = FastMCP("WeatherServer")
    
    @server.tool
    def get_temperature(city: str) -> dict:
        temps = {"NYC": 72, "LA": 85, "Chicago": 68}
        return {"city": city, "temp": temps.get(city, 70)}
    
    return server

@pytest.mark.asyncio
async def test_temperature_tool(weather_server):
    async with Client(weather_server) as client:
        result = await client.call_tool("get_temperature", {"city": "LA"})
        assert result.data == {"city": "LA", "temp": 85}

@pytest.mark.asyncio
async def test_unknown_city(weather_server):
    async with Client(weather_server) as client:
        result = await client.call_tool("get_temperature", {"city": "Paris"})
        assert result.data["temp"] == 70  # 默认温度
```

## 模拟外部依赖

FastMCP 服务器是标准的 Python 对象，因此您可以使用偶好的模拟方法模拟外部依赖。用测试替身替换数据库、API 或任何外部服务，以保持测试快速和确定性。

```python
from unittest.mock import AsyncMock

async def test_database_tool():
    server = FastMCP("DataServer")
    
    # 模拟数据库
    mock_db = AsyncMock()
    mock_db.fetch_users.return_value = [
        {"id": 1, "name": "Alice"},
        {"id": 2, "name": "Bob"}
    ]
    
    @server.tool
    async def list_users() -> list:
        return await mock_db.fetch_users()
    
    async with Client(server) as client:
        result = await client.call_tool("list_users", {})
        assert len(result.data) == 2
        assert result.data[0]["name"] == "Alice"
        mock_db.fetch_users.assert_called_once()
```

## 测试已部署的服务器

虽然内存测试涵盖了大多数单元测试需求，但您偶尔需要对已部署的服务器进行测试 - 以验证身份验证、测试网络行为或验证部署。

### HTTP 传输测试

当您需要测试实际网络行为或验证部署时，使用其 URL 连接到正在运行的服务器：

```python
from fastmcp import Client

async def test_deployed_server():
    # 连接到正在运行的服务器
    async with Client("http://localhost:8000/mcp/") as client:
        await client.ping()
        
        # 使用真实网络传输进行测试
        tools = await client.list_tools()
        assert len(tools) > 0
        
        result = await client.call_tool("greet", {"name": "World"})
        assert "Hello" in result.data
```

### 测试身份验证

FastMCP Client 透明地处理身份验证，使测试受保护的服务器变得容易：

```python
async def test_authenticated_server():
    # Bearer 令牌身份验证
    async with Client(
        "https://api.example.com/mcp",
        headers={"Authorization": "Bearer test-token"}
    ) as client:
        await client.ping()
        tools = await client.list_tools()
        
    # OAuth 流程（打开浏览器进行授权）
    async with Client("https://api.example.com/mcp", auth="oauth") as client:
        result = await client.call_tool("protected_tool", {})
        assert result.data is not None
```

## 最佳实践

1. **默认使用内存测试** - 更快、更可靠、更易于调试
2. **测试行为而非实现** - 调用工具并验证响应，而不是测试内部细节
3. **使用框架固定装置** - 为您的测试套件创建可重用的服务器配置
4. **模拟外部依赖** - 通过模拟数据库、API 等保持测试快速和确定
5. **测试错误情况** - 验证您的服务器正确处理无效输入和边缘情况

FastMCP Client 将 MCP 服务器测试从部署挑战转变为简单的单元测试任务。借助内存连接和确定性控制，您可以构建在毫秒内运行的全面测试套件。