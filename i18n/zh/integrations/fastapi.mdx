---
title: FastAPI ğŸ¤ FastMCP
sidebarTitle: FastAPI
description: å°† FastMCP ä¸ FastAPI åº”ç”¨ç¨‹åºé›†æˆ
icon: bolt
---

import { VersionBadge } from '/snippets/version-badge.mdx'

<Tip>
**2.11 ä¸­çš„æ–°åŠŸèƒ½**ï¼šFastMCP æ­£åœ¨å¼•å…¥ä¸‹ä¸€ä»£ OpenAPI è§£æå™¨ã€‚æ–°è§£æå™¨åœ¨æ€§èƒ½å’Œå…¼å®¹æ€§æ–¹é¢å¤§å¤§æ”¹è¿›ï¼Œä¹Ÿæ›´å®¹æ˜“ç»´æŠ¤ã€‚è¦å¯ç”¨å®ƒï¼Œè¯·è®¾ç½®ç¯å¢ƒå˜é‡ `FASTMCP_EXPERIMENTAL_ENABLE_NEW_OPENAPI_PARSER=true`ã€‚

æ–°è§£æå™¨åœ¨ API æ–¹é¢ä¸ç°æœ‰å®ç°å¤§ä½“å…¼å®¹ï¼Œå¹¶å°†åœ¨æœªæ¥ç‰ˆæœ¬ä¸­æˆä¸ºé»˜è®¤é€‰é¡¹ã€‚æˆ‘ä»¬é¼“åŠ±æ‰€æœ‰ç”¨æˆ·åœ¨å®ƒæˆä¸ºé»˜è®¤é€‰é¡¹ä¹‹å‰æµ‹è¯•å®ƒå¹¶æŠ¥å‘Šä»»ä½•é—®é¢˜ã€‚
</Tip>

FastMCP æä¾›äº†ä¸¤ç§å¼ºå¤§çš„æ–¹å¼æ¥ä¸ FastAPI åº”ç”¨ç¨‹åºé›†æˆï¼š

1. **[ä»æ‚¨çš„ FastAPI åº”ç”¨ç¨‹åºç”Ÿæˆ MCP æœåŠ¡å™¨](#generating-an-mcp-server)** - å°†ç°æœ‰çš„ API ç«¯ç‚¹è½¬æ¢ä¸º MCP å·¥å…·
2. **[å°† MCP æœåŠ¡å™¨æŒ‚è½½åˆ°æ‚¨çš„ FastAPI åº”ç”¨ç¨‹åºä¸­](#mounting-an-mcp-server)** - å‘æ‚¨çš„ Web åº”ç”¨ç¨‹åºæ·»åŠ  MCP åŠŸèƒ½


<Tip>
ä» OpenAPI ç”Ÿæˆ MCP æœåŠ¡å™¨æ˜¯å¼€å§‹ä½¿ç”¨ FastMCP çš„å¥½æ–¹æ³•ï¼Œä½†åœ¨å®è·µä¸­ï¼ŒLLM åœ¨ç²¾å¿ƒè®¾è®¡å’Œç­–åˆ’çš„ MCP æœåŠ¡å™¨ä¸Šçš„**æ€§èƒ½è¡¨ç°æ˜¾è‘—ä¼˜äº**è‡ªåŠ¨è½¬æ¢çš„ OpenAPI æœåŠ¡å™¨ã€‚è¿™å¯¹äºå…·æœ‰è®¸å¤šç«¯ç‚¹å’Œå‚æ•°çš„å¤æ‚ API å°¤å…¶å¦‚æ­¤ã€‚

æˆ‘ä»¬å»ºè®®ä½¿ç”¨ FastAPI é›†æˆè¿›è¡Œå¼•å¯¼å’ŒåŸå‹åˆ¶ä½œï¼Œè€Œä¸æ˜¯å°†æ‚¨çš„ API é•œåƒç»™ LLM å®¢æˆ·ç«¯ã€‚æœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…æ–‡ç«  [åœæ­¢å°†æ‚¨çš„ REST API è½¬æ¢ä¸º MCP](https://www.jlowin.dev/blog/stop-converting-rest-apis-to-mcp)ã€‚
</Tip>


<Note>
FastMCP **ä¸**åŒ…å« FastAPI ä½œä¸ºä¾èµ–ï¼›æ‚¨å¿…é¡»å•ç‹¬å®‰è£…å®ƒæ‰èƒ½ä½¿ç”¨æ­¤é›†æˆã€‚
</Note>

## ç¤ºä¾‹ FastAPI åº”ç”¨ç¨‹åº

åœ¨æ•´ä¸ªæŒ‡å—ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨è¿™ä¸ªç”µå­å•†åŠ¡ API ä½œä¸ºç¤ºä¾‹ï¼ˆç‚¹å‡» `å¤åˆ¶` æŒ‰é’®å¯å¤åˆ¶å®ƒä»¥ä¾¿åœ¨å…¶ä»–ä»£ç å—ä¸­ä½¿ç”¨ï¼‰ï¼š

```python [expandable]
# å°†æ­¤ FastAPI æœåŠ¡å™¨å¤åˆ¶åˆ°æœ¬æŒ‡å—çš„å…¶ä»–ä»£ç å—ä¸­

from fastapi import FastAPI, HTTPException
from pydantic import BaseModel

# æ¨¡å‹
class Product(BaseModel):
    name: str
    price: float
    category: str
    description: str | None = None

class ProductResponse(BaseModel):
    id: int
    name: str
    price: float
    category: str
    description: str | None = None

# åˆ›å»º FastAPI åº”ç”¨ç¨‹åº
app = FastAPI(title="ç”µå­å•†åŠ¡ API", version="1.0.0")

# å†…å­˜æ•°æ®åº“
products_db = {
    1: ProductResponse(
        id=1, name="ç¬”è®°æœ¬ç”µè„‘", price=999.99, category="ç”µå­äº§å“"
    ),
    2: ProductResponse(
        id=2, name="é¼ æ ‡", price=29.99, category="ç”µå­äº§å“"
    ),
    3: ProductResponse(
        id=3, name="åŠå…¬æ¤…", price=299.99, category="å®¶å…·"
    ),
}
next_id = 4

@app.get("/products", response_model=list[ProductResponse])
def list_products(
    category: str | None = None,
    max_price: float | None = None,
) -> list[ProductResponse]:
    """åˆ—å‡ºæ‰€æœ‰äº§å“ï¼Œæ”¯æŒå¯é€‰è¿‡æ»¤ã€‚"""
    products = list(products_db.values())
    if category:
        products = [p for p in products if p.category == category]
    if max_price:
        products = [p for p in products if p.price <= max_price]
    return products

@app.get("/products/{product_id}", response_model=ProductResponse)
def get_product(product_id: int):
    """æ ¹æ® ID è·å–ç‰¹å®šäº§å“ã€‚"""
    if product_id not in products_db:
        raise HTTPException(status_code=404, detail="æœªæ‰¾åˆ°äº§å“")
    return products_db[product_id]

@app.post("/products", response_model=ProductResponse)
def create_product(product: Product):
    """åˆ›å»ºæ–°äº§å“ã€‚"""
    global next_id
    product_response = ProductResponse(id=next_id, **product.model_dump())
    products_db[next_id] = product_response
    next_id += 1
    return product_response

@app.put("/products/{product_id}", response_model=ProductResponse)
def update_product(product_id: int, product: Product):
    """æ›´æ–°ç°æœ‰äº§å“ã€‚"""
    if product_id not in products_db:
        raise HTTPException(status_code=404, detail="æœªæ‰¾åˆ°äº§å“")
    products_db[product_id] = ProductResponse(
        id=product_id,
        **product.model_dump(),
    )
    return products_db[product_id]

@app.delete("/products/{product_id}")
def delete_product(product_id: int):
    """åˆ é™¤äº§å“ã€‚"""
    if product_id not in products_db:
        raise HTTPException(status_code=404, detail="æœªæ‰¾åˆ°äº§å“")
    del products_db[product_id]
    return {"message": "äº§å“å·²åˆ é™¤"}
```

<Tip>
æœ¬æŒ‡å—ä¸­çš„æ‰€æœ‰åç»­ä»£ç ç¤ºä¾‹éƒ½å‡è®¾æ‚¨å·²ç»å®šä¹‰äº†ä¸Šè¿° FastAPI åº”ç”¨ç¨‹åºä»£ç ã€‚æ¯ä¸ªç¤ºä¾‹éƒ½åŸºäºè¿™ä¸ªåŸºç¡€åº”ç”¨ç¨‹åº `app` æ„å»ºã€‚
</Tip>

## ç”Ÿæˆ MCP æœåŠ¡å™¨

<VersionBadge version="2.0.0" />

å¼•å¯¼ MCP æœåŠ¡å™¨æœ€å¸¸è§çš„æ–¹æ³•ä¹‹ä¸€æ˜¯ä»ç°æœ‰çš„ FastAPI åº”ç”¨ç¨‹åºç”Ÿæˆå®ƒã€‚FastMCP å°†æ‚¨çš„ FastAPI ç«¯ç‚¹æš´éœ²ä¸º MCP ç»„ä»¶ï¼ˆé»˜è®¤ä¸ºå·¥å…·ï¼‰ï¼Œä»¥ä¾¿å°†æ‚¨çš„ API æš´éœ²ç»™ LLM å®¢æˆ·ç«¯ã€‚



### åŸºæœ¬è½¬æ¢

ç”¨ä¸€è¡Œä»£ç å°† FastAPI åº”ç”¨ç¨‹åºè½¬æ¢ä¸º MCP æœåŠ¡å™¨ï¼š

```python {5}
# å‡è®¾ä¸Šé¢çš„ FastAPI åº”ç”¨ç¨‹åºå·²ç»å®šä¹‰
from fastmcp import FastMCP

# è½¬æ¢ä¸º MCP æœåŠ¡å™¨
mcp = FastMCP.from_fastapi(app=app)

if __name__ == "__main__":
    mcp.run()
```

### æ·»åŠ ç»„ä»¶

æ‚¨è½¬æ¢çš„ MCP æœåŠ¡å™¨æ˜¯ä¸€ä¸ªå®Œæ•´çš„ FastMCP å®ä¾‹ï¼Œè¿™æ„å‘³ç€æ‚¨å¯ä»¥åƒå¤„ç†ä»»ä½•å…¶ä»– FastMCP å®ä¾‹ä¸€æ ·å‘å…¶æ·»åŠ æ–°å·¥å…·ã€èµ„æºå’Œå…¶ä»–ç»„ä»¶ã€‚

```python {8-11}
# å‡è®¾ä¸Šé¢çš„ FastAPI åº”ç”¨ç¨‹åºå·²ç»å®šä¹‰
from fastmcp import FastMCP

# è½¬æ¢ä¸º MCP æœåŠ¡å™¨
mcp = FastMCP.from_fastapi(app=app)

# æ·»åŠ æ–°å·¥å…·
@mcp.tool
def get_product(product_id: int) -> ProductResponse:
    """æ ¹æ® ID è·å–äº§å“ã€‚"""
    return products_db[product_id]

# è¿è¡Œ MCP æœåŠ¡å™¨
if __name__ == "__main__":
    mcp.run()
```





### ä¸ MCP æœåŠ¡å™¨äº¤äº’

ä¸€æ—¦æ‚¨å°† FastAPI åº”ç”¨ç¨‹åºè½¬æ¢ä¸º MCP æœåŠ¡å™¨ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ FastMCP å®¢æˆ·ç«¯ä¸å…¶äº¤äº’ï¼Œåœ¨å°†å…¶éƒ¨ç½²åˆ°åŸºäº LLM çš„åº”ç”¨ç¨‹åºä¹‹å‰æµ‹è¯•åŠŸèƒ½ã€‚

```python {3, }
# å‡è®¾ä¸Šé¢çš„ FastAPI åº”ç”¨ç¨‹åºå·²ç»å®šä¹‰
from fastmcp import FastMCP
from fastmcp.client import Client
import asyncio

# è½¬æ¢ä¸º MCP æœåŠ¡å™¨
mcp = FastMCP.from_fastapi(app=app)

async def demo():
    async with Client(mcp) as client:
        # åˆ—å‡ºå¯ç”¨å·¥å…·
        tools = await client.list_tools()
        print(f"å¯ç”¨å·¥å…·: {[t.name for t in tools]}")
        
        # åˆ›å»ºäº§å“
        result = await client.call_tool(
            "create_product_products_post",
            {
                "name": "æ— çº¿é”®ç›˜",
                "price": 79.99,
                "category": "ç”µå­äº§å“",
                "description": "è“ç‰™æœºæ¢°é”®ç›˜"
            }
        )
        print(f"å·²åˆ›å»ºäº§å“: {result.data}")
        
        # åˆ—å‡ºä»·æ ¼ä½äº $100 çš„ç”µå­äº§å“
        result = await client.call_tool(
            "list_products_products_get",
            {"category": "ç”µå­äº§å“", "max_price": 100}
        )
        print(f"ç»æµå®æƒ çš„ç”µå­äº§å“: {result.data}")

if __name__ == "__main__":
    asyncio.run(demo())
```

### è‡ªå®šä¹‰è·¯ç”±æ˜ å°„

å› ä¸º FastMCP çš„ FastAPI é›†æˆåŸºäºå…¶ [OpenAPI é›†æˆ](/zh/integrations/openapi)ï¼Œæ‚¨å¯ä»¥ä»¥å®Œå…¨ç›¸åŒçš„æ–¹å¼è‡ªå®šä¹‰ç«¯ç‚¹å¦‚ä½•è½¬æ¢ä¸º MCP ç»„ä»¶ã€‚ä¾‹å¦‚ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ `RouteMap` å°†æ‰€æœ‰ GET è¯·æ±‚æ˜ å°„åˆ° MCP èµ„æºï¼Œå°†æ‰€æœ‰ POST/PUT/DELETE è¯·æ±‚æ˜ å°„åˆ° MCP å·¥å…·ï¼š

```python
# å‡è®¾ä¸Šé¢çš„ FastAPI åº”ç”¨ç¨‹åºå·²ç»å®šä¹‰
from fastmcp import FastMCP
from fastmcp.server.openapi import RouteMap, MCPType

# å¦‚æœä½¿ç”¨å®éªŒæ€§è§£æå™¨ï¼Œè¯·ä»å®éªŒæ¨¡å—å¯¼å…¥ï¼š
# from fastmcp.experimental.server.openapi import RouteMap, MCPType

# è‡ªå®šä¹‰æ˜ å°„è§„åˆ™
mcp = FastMCP.from_fastapi(
    app=app,
    route_maps=[
        # å¸¦æœ‰è·¯å¾„å‚æ•°çš„ GET â†’ ResourceTemplates
        RouteMap(
            methods=["GET"], 
            pattern=r".*\{.*\}.*", 
            mcp_type=MCPType.RESOURCE_TEMPLATE
        ),
        # å…¶ä»– GET â†’ Resources
        RouteMap(
            methods=["GET"], 
            pattern=r".*", 
            mcp_type=MCPType.RESOURCE
        ),
        # POST/PUT/DELETE â†’ Toolsï¼ˆé»˜è®¤ï¼‰
    ],
)

# ç°åœ¨ï¼š
# - GET /products â†’ Resource
# - GET /products/{id} â†’ ResourceTemplate
# - POST/PUT/DELETE â†’ Tools
```

<Tip>
è¦äº†è§£æ›´å¤šå…³äºè‡ªå®šä¹‰è½¬æ¢è¿‡ç¨‹çš„ä¿¡æ¯ï¼Œè¯·å‚é˜… [OpenAPI é›†æˆæŒ‡å—](/zh/integrations/openapi)ã€‚
</Tip>

### èº«ä»½éªŒè¯å’Œè¯·æ±‚å¤´

æ‚¨å¯ä»¥é€šè¿‡ `httpx_client_kwargs` å‚æ•°é…ç½®è¯·æ±‚å¤´å’Œå…¶ä»–å®¢æˆ·ç«¯é€‰é¡¹ã€‚ä¾‹å¦‚ï¼Œè¦ä¸ºæ‚¨çš„ FastAPI åº”ç”¨ç¨‹åºæ·»åŠ èº«ä»½éªŒè¯ï¼Œæ‚¨å¯ä»¥å°† `headers` å­—å…¸ä¼ é€’ç»™ `httpx_client_kwargs` å‚æ•°ï¼š

```python {27-31}
# å‡è®¾ä¸Šé¢çš„ FastAPI åº”ç”¨ç¨‹åºå·²ç»å®šä¹‰
from fastmcp import FastMCP

# ä¸ºæ‚¨çš„ FastAPI åº”ç”¨ç¨‹åºæ·»åŠ èº«ä»½éªŒè¯
from fastapi import Depends, Header
from fastapi.security import HTTPBearer, HTTPAuthorizationCredentials

security = HTTPBearer()

def verify_token(credentials: HTTPAuthorizationCredentials = Depends(security)):
    if credentials.credentials != "secret-token":
        raise HTTPException(status_code=401, detail="æ— æ•ˆçš„èº«ä»½éªŒè¯")
    return credentials.credentials

# æ·»åŠ å—ä¿æŠ¤çš„ç«¯ç‚¹
@app.get("/admin/stats", dependencies=[Depends(verify_token)])
def get_admin_stats():
    return {
        "total_products": len(products_db),
        "categories": list(set(p.category for p in products_db.values()))
    }

# ä½¿ç”¨èº«ä»½éªŒè¯è¯·æ±‚å¤´åˆ›å»º MCP æœåŠ¡å™¨
mcp = FastMCP.from_fastapi(
    app=app,
    httpx_client_kwargs={
        "headers": {
            "Authorization": "Bearer secret-token",
        }
    }
)
```

## æŒ‚è½½ MCP æœåŠ¡å™¨

<VersionBadge version="2.3.1" />

é™¤äº†ç”ŸæˆæœåŠ¡å™¨ä¹‹å¤–ï¼ŒFastMCP è¿˜å¯ä»¥å¸®åŠ©æ‚¨å°† MCP æœåŠ¡å™¨æ·»åŠ åˆ°ç°æœ‰çš„ FastAPI åº”ç”¨ç¨‹åºä¸­ã€‚æ‚¨å¯ä»¥é€šè¿‡æŒ‚è½½ MCP ASGI åº”ç”¨ç¨‹åºæ¥å®ç°è¿™ä¸€ç‚¹ã€‚

### åŸºæœ¬æŒ‚è½½

è¦æŒ‚è½½ MCP æœåŠ¡å™¨ï¼Œæ‚¨å¯ä»¥åœ¨ FastMCP å®ä¾‹ä¸Šä½¿ç”¨ `http_app` æ–¹æ³•ã€‚è¿™å°†è¿”å›ä¸€ä¸ªå¯ä»¥æŒ‚è½½åˆ°æ‚¨çš„ FastAPI åº”ç”¨ç¨‹åºçš„ ASGI åº”ç”¨ç¨‹åºã€‚

```python {23-30}
from fastmcp import FastMCP
from fastapi import FastAPI

# åˆ›å»º MCP æœåŠ¡å™¨
mcp = FastMCP("åˆ†æå·¥å…·")

@mcp.tool
def analyze_pricing(category: str) -> dict:
    """åˆ†ææŸä¸ªç±»åˆ«çš„å®šä»·ã€‚"""
    products = [p for p in products_db.values() if p.category == category]
    if not products:
        return {"error": f"{category} ä¸­æ²¡æœ‰äº§å“"}
    
    prices = [p.price for p in products]
    return {
        "category": category,
        "avg_price": round(sum(prices) / len(prices), 2),
        "min": min(prices),
        "max": max(prices),
    }

# ä» MCP æœåŠ¡å™¨åˆ›å»º ASGI åº”ç”¨ç¨‹åº
mcp_app = mcp.http_app(path='/mcp')

# å…³é”®ï¼šå°†ç”Ÿå‘½å‘¨æœŸä¼ é€’ç»™ FastAPI
app = FastAPI(title="ç”µå­å•†åŠ¡ API", lifespan=mcp_app.lifespan)

# æŒ‚è½½ MCP æœåŠ¡å™¨
app.mount("/analytics", mcp_app)

# ç°åœ¨ï¼šAPI åœ¨ /products/*ï¼ŒMCP åœ¨ /analytics/mcp/
```

## æä¾› LLM å‹å¥½çš„ API

ä¸€ç§å¸¸è§çš„æ¨¡å¼æ˜¯ä»FastAPIåº”ç”¨ç¨‹åºç”ŸæˆMCPæœåŠ¡å™¨ï¼Œå¹¶ä»åŒä¸€åº”ç”¨ç¨‹åºæä¾›ä¸¤ä¸ªæ¥å£ã€‚è¿™ä¸ºæ‚¨çš„å¸¸è§„APIæä¾›äº†ä¸€ä¸ªLLMä¼˜åŒ–çš„æ¥å£ï¼š

```python
# å‡è®¾ä¸Šé¢çš„ FastAPI åº”ç”¨ç¨‹åºå·²ç»å®šä¹‰
from fastmcp import FastMCP
from fastapi import FastAPI

# 1. ä»æ‚¨çš„ API ç”Ÿæˆ MCP æœåŠ¡å™¨
mcp = FastMCP.from_fastapi(app=app, name="ç”µå­å•†åŠ¡ MCP")

# 2. åˆ›å»º MCP çš„ ASGI åº”ç”¨ç¨‹åº
mcp_app = mcp.http_app(path='/mcp')

# 3. åˆ›å»ºä¸€ä¸ªç»“åˆä¸¤ç»„è·¯ç”±çš„æ–° FastAPI åº”ç”¨ç¨‹åº
combined_app = FastAPI(
    title="å¸¦æœ‰ MCP çš„ç”µå­å•†åŠ¡ API",
    routes=[
        *mcp_app.routes,  # MCP è·¯ç”±
        *app.routes,      # åŸå§‹ API è·¯ç”±
    ],
    lifespan=mcp_app.lifespan,
)

# ç°åœ¨æ‚¨æ‹¥æœ‰ï¼š
# - å¸¸è§„ APIï¼šhttp://localhost:8000/products
# - LLM-friendly MCP: http://localhost:8000/mcp/
# ä¸¤è€…éƒ½ä»åŒä¸€ä¸ª FastAPI åº”ç”¨ç¨‹åºæä¾›æœåŠ¡ï¼
```

è¿™ç§æ–¹æ³•è®©æ‚¨å¯ä»¥ç»´æŠ¤å•ä¸€ä»£ç åº“ï¼ŒåŒæ—¶ä¸º LLM å®¢æˆ·ç«¯æä¾›ä¼ ç»Ÿçš„ REST ç«¯ç‚¹å’Œ MCP å…¼å®¹çš„ç«¯ç‚¹ã€‚

## å…³é”®è€ƒè™‘äº‹é¡¹

### æ“ä½œ ID

FastAPI æ“ä½œ ID æˆä¸º MCP ç»„ä»¶åç§°ã€‚å§‹ç»ˆæŒ‡å®šæœ‰æ„ä¹‰çš„æ“ä½œ IDï¼š

```python
# å¥½çš„åšæ³• - æ˜ç¡®çš„ operation_id
@app.get("/users/{user_id}", operation_id="get_user_by_id")
def get_user(user_id: int):
    return {"id": user_id}

# ä¸å¤ªç†æƒ³ - è‡ªåŠ¨ç”Ÿæˆçš„åç§°
@app.get("/users/{user_id}")
def get_user(user_id: int):
    return {"id": user_id}
```

### ç”Ÿå‘½å‘¨æœŸç®¡ç†

æŒ‚è½½ MCP æœåŠ¡å™¨æ—¶ï¼Œå§‹ç»ˆä¼ é€’ç”Ÿå‘½å‘¨æœŸä¸Šä¸‹æ–‡ï¼š

```python
# æ­£ç¡® - ä¼ é€’äº†ç”Ÿå‘½å‘¨æœŸ
mcp_app = mcp.http_app(path='/mcp')
app = FastAPI(lifespan=mcp_app.lifespan)
app.mount("/mcp", mcp_app)

# é”™è¯¯ - ç¼ºå°‘ç”Ÿå‘½å‘¨æœŸ
app = FastAPI()
app.mount("/mcp", mcp.http_app())  # ä¼šè¯ç®¡ç†å™¨ä¸ä¼šåˆå§‹åŒ–
```

å¦‚æœæ‚¨åœ¨è·¯å¾„å‰ç¼€ä¸‹æŒ‚è½½å¯ç”¨èº«ä»½éªŒè¯çš„ MCP æœåŠ¡å™¨ï¼Œè¯·å‚é˜…[æŒ‚è½½å·²è®¤è¯æœåŠ¡å™¨](/zh/deployment/http#mounting-authenticated-servers)ï¼Œäº†è§£å…³é”®çš„ OAuth è·¯ç”±æ³¨æ„äº‹é¡¹ã€‚

### CORS ä¸­é—´ä»¶

å¦‚æœæ‚¨çš„ FastAPI åº”ç”¨ä½¿ç”¨äº† `CORSMiddleware`ï¼Œå¹¶ä¸”æŒ‚è½½äº†å— OAuth ä¿æŠ¤çš„ FastMCP æœåŠ¡å™¨ï¼Œè¯·é¿å…åœ¨æ•´ä¸ªåº”ç”¨ä¸Šæ·»åŠ å…¨å±€ CORS ä¸­é—´ä»¶ã€‚FastMCP ä¸ MCP SDK å·²ç»ä¸º OAuth è·¯ç”±å¤„ç†äº† CORSï¼Œå åŠ ä¸­é—´ä»¶å¯èƒ½å¯¼è‡´å†²çªï¼ˆä¾‹å¦‚ `.well-known` è·¯ç”±æˆ– OPTIONS è¯·æ±‚è¿”å› 404ï¼‰ã€‚

å¦‚æœéœ€è¦ä¸ºè‡ªæœ‰ FastAPI è·¯ç”±å¼€å¯ CORSï¼Œè¯·é‡‡ç”¨å­åº”ç”¨æ¨¡å¼ï¼šåˆ†åˆ«æŒ‚è½½æ‚¨çš„ API ä¸ FastMCPï¼Œæ¯ä¸ªå­åº”ç”¨ä½¿ç”¨å„è‡ªçš„ä¸­é—´ä»¶ï¼Œè€Œä¸æ˜¯åœ¨ç»„åˆåçš„åº”ç”¨ä¸Šæ·»åŠ é¡¶å±‚ `CORSMiddleware`ã€‚

### åˆå¹¶ç”Ÿå‘½å‘¨æœŸ

å¦‚æœæ‚¨çš„ FastAPI åº”ç”¨ç¨‹åºå·²ç»æœ‰ç”Ÿå‘½å‘¨æœŸï¼ˆç”¨äºæ•°æ®åº“è¿æ¥ã€å¯åŠ¨ä»»åŠ¡ç­‰ï¼‰ï¼Œæ‚¨ä¸èƒ½ç®€å•åœ°ç”¨ MCP ç”Ÿå‘½å‘¨æœŸæ›¿æ¢å®ƒã€‚ç›¸åï¼Œæ‚¨éœ€è¦åˆ›å»ºä¸€ä¸ªç®¡ç†ä¸¤ä¸ªä¸Šä¸‹æ–‡çš„æ–°ç”Ÿå‘½å‘¨æœŸå‡½æ•°ã€‚è¿™ç¡®ä¿æ‚¨çš„åº”ç”¨ç¨‹åºåˆå§‹åŒ–é€»è¾‘å’Œ MCP æœåŠ¡å™¨çš„ä¼šè¯ç®¡ç†å™¨éƒ½èƒ½æ­£å¸¸è¿è¡Œï¼š

```python
from contextlib import asynccontextmanager
from fastapi import FastAPI
from fastmcp import FastMCP

# æ‚¨ç°æœ‰çš„ç”Ÿå‘½å‘¨æœŸ
@asynccontextmanager
async def app_lifespan(app: FastAPI):
    # å¯åŠ¨
    print("æ­£åœ¨å¯åŠ¨åº”ç”¨ç¨‹åº...")
    # åˆå§‹åŒ–æ•°æ®åº“ã€ç¼“å­˜ç­‰
    yield
    # å…³é—­
    print("æ­£åœ¨å…³é—­åº”ç”¨ç¨‹åº...")

# åˆ›å»º MCP æœåŠ¡å™¨
mcp = FastMCP("å·¥å…·")
mcp_app = mcp.http_app(path='/mcp')

# åˆå¹¶ä¸¤ä¸ªç”Ÿå‘½å‘¨æœŸ
@asynccontextmanager
async def combined_lifespan(app: FastAPI):
    # è¿è¡Œä¸¤ä¸ªç”Ÿå‘½å‘¨æœŸ
    async with app_lifespan(app):
        async with mcp_app.lifespan(app):
            yield

# ä½¿ç”¨åˆå¹¶çš„ç”Ÿå‘½å‘¨æœŸ
app = FastAPI(lifespan=combined_lifespan)
app.mount("/mcp", mcp_app)
```

è¿™ä¸ªæ¨¡å¼ç¡®ä¿æ‚¨çš„åº”ç”¨ç¨‹åºåˆå§‹åŒ–é€»è¾‘å’Œ MCP æœåŠ¡å™¨çš„ä¼šè¯ç®¡ç†å™¨éƒ½å¾—åˆ°æ­£ç¡®ç®¡ç†ã€‚å…³é”®æ˜¯ä½¿ç”¨åµŒå¥—çš„ `async with` è¯­å¥ - å†…éƒ¨ä¸Šä¸‹æ–‡ï¼ˆMCPï¼‰å°†åœ¨å¤–éƒ¨ä¸Šä¸‹æ–‡ï¼ˆæ‚¨çš„åº”ç”¨ç¨‹åºï¼‰ä¹‹ååˆå§‹åŒ–ï¼Œå¹¶åœ¨å®ƒä¹‹å‰æ¸…ç†ã€‚è¿™ä¸ºæ‚¨çš„æ‰€æœ‰èµ„æºç»´æŠ¤äº†æ­£ç¡®çš„åˆå§‹åŒ–å’Œæ¸…ç†é¡ºåºã€‚

### æ€§èƒ½æç¤º

1. **ä½¿ç”¨å†…å­˜ä¼ è¾“è¿›è¡Œæµ‹è¯•** - å°† MCP æœåŠ¡å™¨ç›´æ¥ä¼ é€’ç»™å®¢æˆ·ç«¯
2. **è®¾è®¡ä¸“ç”¨çš„ MCP å·¥å…·** - æ¯”è‡ªåŠ¨è½¬æ¢å¤æ‚ API æ›´å¥½
3. **ä¿æŒå·¥å…·å‚æ•°ç®€å•** - LLM åœ¨ä¸“æ³¨çš„æ¥å£ä¸Šè¡¨ç°æ›´å¥½

æœ‰å…³é…ç½®é€‰é¡¹çš„æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜… [OpenAPI é›†æˆæŒ‡å—](/zh/integrations/openapi)ã€‚