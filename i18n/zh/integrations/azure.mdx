---
title: Azure（Microsoft Entra ID）OAuth 🤝 FastMCP
sidebarTitle: Azure（Entra ID）
description: 使用 Azure/Microsoft Entra OAuth 保护您的 FastMCP 服务器
icon: microsoft
tag: NEW
---

import { VersionBadge } from "/snippets/version-badge.mdx"

<VersionBadge version="2.13.0" />

本指南向您展示如何使用 **Azure OAuth**（Microsoft Entra ID）保护 FastMCP 服务器。由于 Azure 不支持动态客户端注册，此集成采用 [**OAuth 代理**](/zh/servers/auth/oauth-proxy) 模式，将 Azure 的传统 OAuth 与 MCP 的身份验证需求衔接起来。FastMCP 会基于应用程序的 `client_id` 验证 Azure JWT。

## 配置

### 先决条件

在开始之前，您需要：
1. 一个具有创建应用注册权限的 **[Azure 账户](https://portal.azure.com/)**
2. 您的 FastMCP 服务器 URL（开发时可以是 localhost，例如 `http://localhost:8000`）
3. 您的 Azure 租户 ID（在 Azure 门户的 Microsoft Entra ID 下可以找到）

### 第 1 步：创建 Azure 应用注册

在 Azure 门户中创建应用注册以获取身份验证所需的凭据：

<Steps>
<Step title="导航到应用注册">
    转到 [Azure 门户](https://portal.azure.com)并导航到 **Microsoft Entra ID → 应用注册**。
    
    点击 **"新注册"** 创建新应用程序。
</Step>

<Step title="配置您的应用程序">
    填写应用程序详细信息：
    
    - **名称**：选择用户可以识别的名称（例如，"我的 FastMCP 服务器"）
    - **支持的账户类型**：根据您的需要选择：
      - **单租户**：仅您组织中的用户
      - **多租户**：任何 Microsoft Entra 目录中的用户
      - **多租户 + 个人账户**：任何 Microsoft 账户
    - **重定向 URI**：选择 "Web" 并输入您的服务器 URL + `/auth/callback`（例如，`http://localhost:8000/auth/callback`）
    
    <Warning>
    重定向 URI 必须完全匹配。默认路径是 `/auth/callback`，但您可以使用 `redirect_path` 参数进行自定义。对于本地开发，Azure 允许 `http://localhost` URL。对于生产环境，您必须使用 HTTPS。
    </Warning>
    
    <Tip>
    如果您想使用自定义回调路径（例如，`/auth/azure/callback`），请确保在 Azure 应用注册和配置 AzureProvider 时的 `redirect_path` 参数中设置相同的路径。
    </Tip>

    - **公开 API**：配置您的应用程序 ID URI 并定义作用域
      - 在应用注册侧边栏中转到**公开 API**。
      - 点击“应用程序 ID URI”旁边的**设置**，并选择以下之一：
        - 保持默认的 `api://{client_id}`
        - 设置自定义值，遵循支持的格式（参见 [标识符 URI 限制](https://learn.microsoft.com/en-us/entra/identity-platform/identifier-uri-restrictions)）
      - 点击**添加作用域**并创建您的应用程序所需的作用域，例如：
        - 作用域名称：`read`（或 `write` 等）
        - 管理员同意显示名称/描述：适合您的组织
        - 谁可以同意：根据需要（仅管理员或管理员和用户）

    - **配置访问令牌版本**：确保您的应用程序使用访问令牌 v2
      - 在应用注册侧边栏中转到**清单**。
      - 找到 `requestedAccessTokenVersion` 属性并将其设置为 `2`：
        ```json
        "api": {
            "requestedAccessTokenVersion": 2
        }
        ```
      - 在清单编辑器顶部点击**保存**。

    <Warning>
    FastMCP 的 Azure 集成需要访问令牌 v2 才能正常工作。如果未设置，您可能会遇到身份验证错误。
    </Warning>

    <Note>
    在 FastMCP 的 `AzureProvider` 中，将 `identifier_uri` 设置为您的应用程序 ID URI（可选；默认为 `api://{client_id}`），并将 `required_scopes` 设置为未加前缀的作用域名称（例如 `read`、`write`）。授权流程中，FastMCP 会自动为作用域补上 `identifier_uri` 前缀。
    </Note>


</Step>


<Step title="创建客户端密钥">
    注册后，在您的应用设置中导航到 **证书和密钥**。
    
    - 点击 **"新客户端密钥"**
    - 添加描述（例如，"FastMCP 服务器"）
    - 选择过期时间
    - 点击 **"添加"**
    
    <Warning>
    立即复制密钥值 - 它不会再次显示！如果丢失，您需要创建新的密钥。
    </Warning>
</Step>

<Step title="记录您的凭据">
    从您的应用注册的 **概览** 页面，记录：
    
    - **应用程序（客户端）ID**：像 `835f09b6-0f0f-40cc-85cb-f32c5829a149` 这样的 UUID
    - **目录（租户）ID**：像 `08541b6e-646d-43de-a0eb-834e6713d6d5` 这样的 UUID
    - **客户端密钥**：您在上一步中复制的值
    
    <Tip>
    安全存储这些凭据。永远不要将它们提交到版本控制。在生产环境中使用环境变量或密钥管理器。
    </Tip>
</Step>
</Steps>

### 第 2 步：FastMCP 配置

使用 `AzureProvider` 创建您的 FastMCP 服务器，它会自动处理 Azure 的 OAuth 流程：

```python server.py
from fastmcp import FastMCP
from fastmcp.server.auth.providers.azure import AzureProvider

# AzureProvider 处理 Azure 的令牌格式和验证
auth_provider = AzureProvider(
    client_id="835f09b6-0f0f-40cc-85cb-f32c5829a149",  # 您的 Azure 应用客户端 ID
    client_secret="your-client-secret",                 # 您的 Azure 应用客户端密钥
    tenant_id="08541b6e-646d-43de-a0eb-834e6713d6d5", # 您的 Azure 租户 ID（必需）
    base_url="http://localhost:8000",                   # 必须与您的应用注册匹配
    required_scopes=["your-scope"],                 # 必填：至少一个作用域，来自您的应用注册
    # identifier_uri 默认为 api://{client_id}
    # identifier_uri="api://your-api-id",
    # 可选：在授权请求中请求附加的上游作用域
    # additional_authorize_scopes=["User.Read", "offline_access", "openid", "email"],
    # redirect_path="/auth/callback"                  # Default value, customize if needed
)

mcp = FastMCP(name="Azure Secured App", auth=auth_provider)

# 添加受保护的工具来测试身份验证
@mcp.tool
async def get_user_info() -> dict:
    """返回经过身份验证的 Azure 用户信息。"""
    from fastmcp.server.dependencies import get_access_token
    
    token = get_access_token()
    # AzureProvider 在令牌声明中存储用户数据
    return {
        "azure_id": token.claims.get("sub"),
        "email": token.claims.get("email"),
        "name": token.claims.get("name"),
        "job_title": token.claims.get("job_title"),
        "office_location": token.claims.get("office_location")
    }
```

<Note>
**重要**：`tenant_id` 参数是 **必需的**。由于安全要求，Azure 不再支持为新应用程序使用 "common"。您必须使用以下之一：

- **您的特定租户 ID**：在 Azure 门户中找到（例如，`08541b6e-646d-43de-a0eb-834e6713d6d5`）
- **"organizations"**：仅限工作和学校账户
- **"consumers"**：仅限个人 Microsoft 账户

推荐使用您的特定租户 ID 以获得更好的安全性和控制。
</Note>

<Note>
**重要**：`required_scopes` 参数是**必填项**，必须至少包含一个作用域。Azure 的 OAuth API 要求每个授权请求都带上 `scope` 参数，否则无法完成认证。请使用 Azure 应用注册中“公开 API”所创建的未加前缀作用域名称（例如 `["read", "write"]`）。
</Note>

## 测试

### 运行服务器

使用 HTTP 传输启动您的 FastMCP 服务器以启用 OAuth 流程：

```bash
fastmcp run server.py --transport http --port 8000
```

您的服务器现在正在运行并受到 Azure OAuth 身份验证的保护。

### 使用客户端测试

创建一个与您的 Azure 保护服务器进行身份验证的测试客户端：

```python test_client.py
from fastmcp import Client
import asyncio

async def main():
    # 客户端将自动处理 Azure OAuth
    async with Client("http://localhost:8000/mcp/", auth="oauth") as client:
        # 首次连接将在浏览器中打开 Azure 登录
        print("✓ 已通过 Azure 身份验证！")
        
        # 测试受保护的工具
        result = await client.call_tool("get_user_info")
        print(f"Azure 用户：{result['email']}")
        print(f"姓名：{result['name']}")

if __name__ == "__main__":
    asyncio.run(main())
```

当您首次运行客户端时：
1. 您的浏览器将打开 Microsoft 的授权页面
2. 使用您的 Microsoft 账户登录（根据您的租户配置，可以是工作、学校或个人账户）
3. 授予请求的权限
4. 授权后，您将被重定向回去
5. 客户端接收令牌并可以发出经过身份验证的请求

<Info>
客户端在本地缓存令牌，因此除非令牌过期或您显式清除缓存，否则您无需为后续运行重新进行身份验证。
</Info>

## 生产环境配置

<VersionBadge version="2.13.0" />

在生产部署中，为了在服务器重启后仍能保留令牌，请同时配置 `jwt_signing_key` 与 `client_storage`：

```python server.py
import os
from fastmcp import FastMCP
from fastmcp.server.auth.providers.azure import AzureProvider
from key_value.aio.stores.redis import RedisStore
from key_value.aio.wrappers.encryption import FernetEncryptionWrapper
from cryptography.fernet import Fernet

# 使用加密的持久化令牌存储进行生产配置
auth_provider = AzureProvider(
    client_id="835f09b6-0f0f-40cc-85cb-f32c5829a149",
    client_secret="your-client-secret",
    tenant_id="08541b6e-646d-43de-a0eb-834e6713d6d5",
    base_url="https://your-production-domain.com",
    required_scopes=["your-scope"],

    # 生产环境令牌管理
    jwt_signing_key=os.environ["JWT_SIGNING_KEY"],
    client_storage=FernetEncryptionWrapper(
        key_value=RedisStore(
            host=os.environ["REDIS_HOST"],
            port=int(os.environ["REDIS_PORT"])
        ),
        fernet=Fernet(os.environ["STORAGE_ENCRYPTION_KEY"])
    )
)

mcp = FastMCP(name="Production Azure App", auth=auth_provider)
```

<Note>
`jwt_signing_key` 与 `client_storage` 需要配合使用，才能在服务器重启后保留令牌与客户端注册信息。**请使用 `FernetEncryptionWrapper` 加密存储中的敏感 OAuth 令牌**，否则将以明文保存。建议将密钥存放在环境变量中，并选择 Redis 等持久化后端以支持分布式部署。

更多参数说明请参阅 [OAuth 代理文档](/zh/servers/auth/oauth-proxy#configuration-parameters)。
</Note>

## 环境变量

<VersionBadge version="2.12.1" />

对于生产部署，请使用环境变量而不是硬编码凭据。

### 提供程序选择

设置此环境变量允许自动使用 Azure 提供程序，而无需在代码中显式实例化它。

<Card>
<ParamField path="FASTMCP_SERVER_AUTH" default="未设置">
设置为 `fastmcp.server.auth.providers.azure.AzureProvider` 以使用 Azure 身份验证。
</ParamField>
</Card>

### Azure 特定配置

这些环境变量为 Azure 提供程序提供默认值，无论它是手动实例化的还是通过 `FASTMCP_SERVER_AUTH` 配置的。

<Card>
<ParamField path="FASTMCP_SERVER_AUTH_AZURE_CLIENT_ID" required>
您的 Azure 应用注册客户端 ID（例如，`835f09b6-0f0f-40cc-85cb-f32c5829a149`）
</ParamField>

<ParamField path="FASTMCP_SERVER_AUTH_AZURE_CLIENT_SECRET" required>
您的 Azure 应用注册客户端密钥
</ParamField>

<ParamField path="FASTMCP_SERVER_AUTH_AZURE_TENANT_ID" required>
您的 Azure 租户 ID（特定 ID、"organizations" 或 "consumers"）

<Note>
这是 **必需的**。在 Azure 门户的 Microsoft Entra ID → 概览 下找到您的租户 ID。
</Note>
</ParamField>

<ParamField path="FASTMCP_SERVER_AUTH_AZURE_BASE_URL" default="http://localhost:8000">
OAuth 端点可访问的公共 URL（包含任何挂载路径）
</ParamField>

<ParamField path="FASTMCP_SERVER_AUTH_AZURE_ISSUER_URL" default="使用 BASE_URL">
用于 OAuth 元数据的 Issuer URL（默认等于 `BASE_URL`）。当挂载在路径前缀下时，请设置为根级 URL 以避免 404 日志。详见 [HTTP 部署指南](/zh/deployment/http#mounting-authenticated-servers)。
</ParamField>

<ParamField path="FASTMCP_SERVER_AUTH_AZURE_REDIRECT_PATH" default="/auth/callback">
在您的 Azure 应用注册中配置的重定向路径
</ParamField>

<ParamField path="FASTMCP_SERVER_AUTH_AZURE_REQUIRED_SCOPES" required>
您的 API 所需的作用域列表，使用逗号、空格或 JSON 分隔（至少需要一个作用域）。这些作用域会在令牌上验证，并在客户端未请求特定作用域时作为默认值。请使用应用注册中未加前缀的作用域名称（例如 `read,write`）。

<Note>
Azure 的 OAuth API 要求提供 `scope` 参数——必须至少配置一个作用域。
</Note>
</ParamField>

<ParamField path="FASTMCP_SERVER_AUTH_AZURE_ADDITIONAL_AUTHORIZE_SCOPES" default="">
在授权请求中包含的附加作用域的逗号、空格或 JSON 分隔列表，不加前缀。使用此功能请求上游作用域，如 Microsoft Graph 权限。这些不用于令牌验证。
</ParamField>

<ParamField path="FASTMCP_SERVER_AUTH_AZURE_IDENTIFIER_URI" default="api://{client_id}">
在授权期间用于为作用域加前缀的应用程序 ID URI。
</ParamField>
</Card>

示例 `.env` 文件：
```bash
# 使用 Azure 提供程序
FASTMCP_SERVER_AUTH=fastmcp.server.auth.providers.azure.AzureProvider

# Azure OAuth 凭据
FASTMCP_SERVER_AUTH_AZURE_CLIENT_ID=835f09b6-0f0f-40cc-85cb-f32c5829a149
FASTMCP_SERVER_AUTH_AZURE_CLIENT_SECRET=your-client-secret-here
FASTMCP_SERVER_AUTH_AZURE_TENANT_ID=08541b6e-646d-43de-a0eb-834e6713d6d5
FASTMCP_SERVER_AUTH_AZURE_BASE_URL=https://your-server.com
FASTMCP_SERVER_AUTH_AZURE_REQUIRED_SCOPES=read,write
# 可选自定义API配置
# FASTMCP_SERVER_AUTH_AZURE_IDENTIFIER_URI=api://your-api-id
# 请求附加上游范围（可选）
# FASTMCP_SERVER_AUTH_AZURE_ADDITIONAL_AUTHORIZE_SCOPES=User.Read,Mail.Read
```

设置环境变量后，您的服务器代码简化为：

```python server.py
from fastmcp import FastMCP

# 身份验证从环境中自动配置
mcp = FastMCP(name="Azure 安全应用")

@mcp.tool
async def protected_tool(query: str) -> str:
    """需要 Azure 身份验证才能访问的工具。"""
    # 您的工具实现在这里
    return f"处理经过身份验证的请求：{query}"
```
