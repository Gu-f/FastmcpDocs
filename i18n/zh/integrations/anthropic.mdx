---
title: Anthropic API ğŸ¤ FastMCP
sidebarTitle: Anthropic API
description: ä» Anthropic API è°ƒç”¨ FastMCP æœåŠ¡å™¨
icon: message-code
---

import { VersionBadge } from "/snippets/version-badge.mdx"


Anthropic çš„ [Messages API](https://docs.anthropic.com/en/api/messages) æ”¯æŒå°† MCP æœåŠ¡å™¨ä½œä¸ºè¿œç¨‹å·¥å…·æºã€‚æœ¬æ•™ç¨‹å°†å‘æ‚¨å±•ç¤ºå¦‚ä½•åˆ›å»ºä¸€ä¸ª FastMCP æœåŠ¡å™¨å¹¶å°†å…¶éƒ¨ç½²åˆ°å…¬å…± URLï¼Œç„¶åå¦‚ä½•ä» Messages API è°ƒç”¨å®ƒã€‚

<Tip>
ç›®å‰ï¼ŒMCP è¿æ¥å™¨ä»…ä» MCP æœåŠ¡å™¨è®¿é—®**å·¥å…·**â€”â€”å®ƒæŸ¥è¯¢ `list_tools` ç«¯ç‚¹å¹¶å°†è¿™äº›åŠŸèƒ½å…¬å¼€ç»™ Claudeã€‚å…¶ä»– MCP åŠŸèƒ½ï¼ˆå¦‚èµ„æºå’Œæç¤ºï¼‰ç›®å‰ä¸å—æ”¯æŒã€‚æ‚¨å¯ä»¥åœ¨ [Anthropic æ–‡æ¡£](https://docs.anthropic.com/en/docs/agents-and-tools/mcp-connector) ä¸­äº†è§£æ›´å¤šå…³äº MCP è¿æ¥å™¨çš„ä¿¡æ¯ã€‚
</Tip>

## åˆ›å»ºæœåŠ¡å™¨

é¦–å…ˆï¼Œåˆ›å»ºä¸€ä¸ªåŒ…å«æ‚¨è¦å…¬å¼€çš„å·¥å…·çš„ FastMCP æœåŠ¡å™¨ã€‚åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªæœåŠ¡å™¨ï¼Œå®ƒåŒ…å«ä¸€ä¸ªå•ä¸€çš„å·¥å…·ï¼Œè¿™ä¸ªå·¥å…·èƒ½æ·éª°å­ã€‚

```python server.py
import random
from fastmcp import FastMCP

mcp = FastMCP(name="éª°å­æŠ•æ·å™¨")

@mcp.tool
def roll_dice(n_dice: int) -> list[int]:
    """æ· `n_dice` ä¸ªå…­é¢éª°å­ï¼Œå¹¶è¿”å›ç»“æœã€‚"""
    return [random.randint(1, 6) for _ in range(n_dice)]

if __name__ == "__main__":
    mcp.run(transport="http", port=8000)
```

## éƒ¨ç½²æœåŠ¡å™¨

æ‚¨çš„æœåŠ¡å™¨å¿…é¡»éƒ¨ç½²åˆ°å…¬å…± URLï¼Œä»¥ä¾¿ Anthropic è®¿é—®å®ƒã€‚MCP è¿æ¥å™¨æ”¯æŒ SSE å’Œ Streamable HTTP ä¼ è¾“ã€‚

å¯¹äºå¼€å‘ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ `ngrok` ç­‰å·¥å…·ä¸´æ—¶å°†æœ¬åœ°è¿è¡Œçš„æœåŠ¡å™¨æš´éœ²åˆ°äº’è”ç½‘ã€‚æˆ‘ä»¬å°†åœ¨æ­¤ç¤ºä¾‹ä¸­è¿™æ ·åšï¼ˆæ‚¨å¯èƒ½éœ€è¦å®‰è£… `ngrok` å¹¶åˆ›å»ºä¸€ä¸ªå…è´¹è´¦æˆ·ï¼‰ï¼Œä½†æ‚¨å¯ä»¥ä½¿ç”¨ä»»ä½•å…¶ä»–æ–¹æ³•æ¥éƒ¨ç½²æ‚¨çš„æœåŠ¡å™¨ã€‚

å‡è®¾æ‚¨å°†ä¸Šè¿°ä»£ç ä¿å­˜ä¸º `server.py`ï¼Œæ‚¨å¯ä»¥åœ¨ä¸¤ä¸ªå•ç‹¬çš„ç»ˆç«¯ä¸­è¿è¡Œä»¥ä¸‹ä¸¤ä¸ªå‘½ä»¤æ¥éƒ¨ç½²æ‚¨çš„æœåŠ¡å™¨å¹¶å°†å…¶æš´éœ²åˆ°äº’è”ç½‘ï¼š

<CodeGroup>
```bash FastMCP server
python server.py
```

```bash ngrok
ngrok http 8000
```
</CodeGroup>

<Warning>
è¿™ä¼šå°†æ‚¨çš„æœªè®¤è¯æœåŠ¡å™¨æš´éœ²åˆ°äº’è”ç½‘ã€‚å¦‚æœæ‚¨äº†è§£é£é™©ï¼Œåªèƒ½åœ¨å®‰å…¨ç¯å¢ƒä¸­è¿è¡Œæ­¤å‘½ä»¤ã€‚
</Warning>

## è°ƒç”¨æœåŠ¡å™¨

è¦åœ¨ MCP æœåŠ¡å™¨ä¸Šä½¿ç”¨ Messages APIï¼Œæ‚¨éœ€è¦å®‰è£… Anthropic Python SDKï¼ˆFastMCP ä¸åŒ…å«ï¼‰ï¼š

```bash
pip install anthropic
```

æ‚¨è¿˜éœ€è¦å‘ Anthropic è¿›è¡Œèº«ä»½éªŒè¯ã€‚æ‚¨å¯ä»¥é€šè¿‡è®¾ç½® `ANTHROPIC_API_KEY` ç¯å¢ƒå˜é‡æ¥å®ç°ã€‚è¯·æŸ¥é˜… Anthropic SDK æ–‡æ¡£ä»¥è·å–æ›´å¤šä¿¡æ¯ã€‚

```bash
export ANTHROPIC_API_KEY="your-api-key"
```

ä»¥ä¸‹æ˜¯å¦‚ä½•ä» Python è°ƒç”¨æ‚¨çš„æœåŠ¡å™¨çš„ç¤ºä¾‹ã€‚è¯·æ³¨æ„ï¼Œæ‚¨éœ€è¦å°† `https://your-server-url.com` æ›¿æ¢ä¸ºæ‚¨æœåŠ¡å™¨çš„å®é™… URLã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬ä½¿ç”¨ `/mcp/` ä½œä¸ºç«¯ç‚¹ï¼Œå› ä¸ºæˆ‘ä»¬éƒ¨ç½²äº†ä¸€ä¸ªä½¿ç”¨é»˜è®¤è·¯å¾„çš„ streamable-HTTP æœåŠ¡å™¨ï¼›å¦‚æœæ‚¨è‡ªå®šä¹‰äº†æœåŠ¡å™¨çš„éƒ¨ç½²ï¼Œå¯èƒ½éœ€è¦ä½¿ç”¨ä¸åŒçš„ç«¯ç‚¹ã€‚**ç›®å‰æ‚¨è¿˜å¿…é¡»åŒ…å«å¸¦æœ‰ `anthropic-beta` æ ‡å¤´çš„ `extra_headers` å‚æ•°ã€‚**

```python {5, 13-22}
import anthropic
from rich import print

# æ‚¨çš„æœåŠ¡å™¨ç½‘å€ï¼ˆè¯·å°†å…¶æ›¿æ¢ä¸ºæ‚¨çš„å®é™…ç½‘å€ï¼‰
url = 'https://your-server-url.com'

client = anthropic.Anthropic()

response = client.beta.messages.create(
    model="claude-sonnet-4-20250514",
    max_tokens=1000,
    messages=[{"role": "user", "content": "Roll a few dice!"}],
    mcp_servers=[
        {
            "type": "url",
            "url": f"{url}/mcp/",
            "name": "dice-server",
        }
    ],
    extra_headers={
        "anthropic-beta": "mcp-client-2025-04-04"
    }
)

print(response.content)
```

å¦‚æœæ‚¨è¿è¡Œæ­¤ä»£ç ï¼Œæ‚¨å°†çœ‹åˆ°å¦‚ä¸‹è¾“å‡ºï¼š

```text
æˆ‘æ¥ä¸ºæ‚¨æ·éª°å­ï¼è®©æˆ‘ä½¿ç”¨æ·éª°å­å·¥å…·ã€‚

æˆ‘æ·äº† 3 ä¸ªéª°å­ï¼Œå¾—åˆ°ï¼š4ã€2ã€6

ç»“æœæ˜¯ 4ã€2 å’Œ 6ã€‚æ‚¨æƒ³è®©æˆ‘å†æ·ä¸€æ¬¡æˆ–æ·ä¸åŒæ•°é‡çš„éª°å­å—ï¼Ÿ
```


## èº«ä»½éªŒè¯

<VersionBadge version="2.6.0" />

MCP è¿æ¥å™¨é€šè¿‡æˆæƒä»¤ç‰Œæ”¯æŒ OAuth èº«ä»½éªŒè¯ï¼Œè¿™æ„å‘³ç€æ‚¨å¯ä»¥ä¿æŠ¤æ‚¨çš„æœåŠ¡å™¨ï¼ŒåŒæ—¶ä»ç„¶å…è®¸ Anthropic è®¿é—®å®ƒã€‚

### æœåŠ¡å™¨èº«ä»½éªŒè¯

å‘æœåŠ¡å™¨æ·»åŠ èº«ä»½éªŒè¯çš„æœ€ç®€å•æ–¹æ³•æ˜¯ä½¿ç”¨æ‰¿è½½ä»¤ç‰Œæ–¹æ¡ˆã€‚

åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ FastMCP çš„ `RSAKeyPair` å®ç”¨ç¨‹åºå¿«é€Ÿç”Ÿæˆæˆ‘ä»¬è‡ªå·±çš„ä»¤ç‰Œï¼Œä½†è¿™å¯èƒ½ä¸é€‚åˆç”Ÿäº§ä½¿ç”¨ã€‚æœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…å®Œæ•´çš„æœåŠ¡å™¨ç«¯[ä»¤ç‰ŒéªŒè¯](/zh/servers/auth/token-verification)æ–‡æ¡£ã€‚

æˆ‘ä»¬å°†é¦–å…ˆåˆ›å»ºä¸€ä¸ª RSA å¯†é’¥å¯¹æ¥ç­¾åå’ŒéªŒè¯ä»¤ç‰Œã€‚

```python
from fastmcp.server.auth.providers.jwt import RSAKeyPair

key_pair = RSAKeyPair.generate()
access_token = key_pair.create_token(audience="dice-server")
```

<Warning>
FastMCP çš„ `RSAKeyPair` å®ç”¨ç¨‹åºä»…ç”¨äºå¼€å‘å’Œæµ‹è¯•ã€‚
</Warning> 

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ª `JWTVerifier` æ¥éªŒè¯æœåŠ¡å™¨ã€‚

```python
from fastmcp import FastMCP
from fastmcp.server.auth import JWTVerifier

auth = JWTVerifier(
    public_key=key_pair.public_key,
    audience="dice-server",
)

mcp = FastMCP(name="Dice Roller", auth=auth)
```

è¿™æ˜¯ä¸€ä¸ªå¯ä»¥å¤åˆ¶/ç²˜è´´çš„å®Œæ•´ç¤ºä¾‹ã€‚ä¸ºäº†ç®€å•èµ·è§ï¼Œä»…å‡ºäºæ­¤ç¤ºä¾‹çš„ç›®çš„ï¼Œå®ƒå°†ä»¤ç‰Œæ‰“å°åˆ°æ§åˆ¶å°ã€‚**ä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è¿™æ ·åšï¼**

```python server.py [expandable]
from fastmcp import FastMCP
from fastmcp.server.auth import JWTVerifier
from fastmcp.server.auth.providers.jwt import RSAKeyPair
import random

key_pair = RSAKeyPair.generate()
access_token = key_pair.create_token(audience="dice-server")

auth = JWTVerifier(
    public_key=key_pair.public_key,
    audience="dice-server",
)

mcp = FastMCP(name="Dice Roller", auth=auth)

@mcp.tool
def roll_dice(n_dice: int) -> list[int]:
    """æ· `n_dice` ä¸ªå…­é¢éª°å­ï¼Œå¹¶è¿”å›ç»“æœã€‚"""
    return [random.randint(1, 6) for _ in range(n_dice)]

if __name__ == "__main__":
    print(f"\n---\n\nğŸ”‘ éª°å­æŠ•æ·å™¨ access token:\n\n{access_token}\n\n---\n")
    mcp.run(transport="http", port=8000)
```

### å®¢æˆ·ç«¯èº«ä»½éªŒè¯

å¦‚æœæ‚¨å°è¯•ä½¿ç”¨æˆ‘ä»¬ä¹‹å‰ç¼–å†™çš„ç›¸åŒ Anthropic ä»£ç è°ƒç”¨ç»è¿‡èº«ä»½éªŒè¯çš„æœåŠ¡å™¨ï¼Œæ‚¨å°†æ”¶åˆ°ä¸€ä¸ªé”™è¯¯ï¼ŒæŒ‡ç¤ºæœåŠ¡å™¨å› æœªè¿›è¡Œèº«ä»½éªŒè¯è€Œæ‹’ç»äº†è¯·æ±‚ã€‚

```python
Error code: 400 - {
    "type": "error", 
    "error": {
        "type": "invalid_request_error", 
        "message": "MCP æœåŠ¡å™¨â€œdice-serverâ€éœ€è¦è¿›è¡Œèº«ä»½éªŒè¯ã€‚è¯·æä¾›æˆæƒä»¤ç‰Œã€‚",
    },
}
```

è¦éªŒè¯å®¢æˆ·ç«¯ï¼Œæ‚¨å¯ä»¥åœ¨ MCP æœåŠ¡å™¨é…ç½®ä¸­ä½¿ç”¨ `authorization_token` å‚æ•°ä¼ é€’ä»¤ç‰Œï¼š

```python {8, 21}
import anthropic
from rich import print

# æ‚¨çš„æœåŠ¡å™¨ç½‘å€ï¼ˆè¯·å°†å…¶æ›¿æ¢ä¸ºæ‚¨çš„å®é™…ç½‘å€ï¼‰
url = 'https://your-server-url.com'

# æ‚¨çš„è®¿é—®ä»¤ç‰Œï¼ˆè¯·å°†æ­¤å¤„çš„â€œä»¤ç‰Œâ€æ›¿æ¢ä¸ºæ‚¨å®é™…çš„ä»¤ç‰Œï¼‰
access_token = 'your-access-token'

client = anthropic.Anthropic()

response = client.beta.messages.create(
    model="claude-sonnet-4-20250514",
    max_tokens=1000,
    messages=[{"role": "user", "content": "Roll a few dice!"}],
    mcp_servers=[
        {
            "type": "url",
            "url": f"{url}/mcp/",
            "name": "dice-server",
            "authorization_token": access_token
        }
    ],
    extra_headers={
        "anthropic-beta": "mcp-client-2025-04-04"
    }
)

print(response.content)
```

æ‚¨ç°åœ¨åº”è¯¥åœ¨è¾“å‡ºä¸­çœ‹åˆ°æ·éª°å­ç»“æœã€‚
