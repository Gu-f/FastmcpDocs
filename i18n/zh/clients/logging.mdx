---
title: 服务器日志记录
sidebarTitle: 日志记录
description: 接收和处理来自 MCP 服务器的日志消息。
icon: receipt
---

import { VersionBadge } from '/snippets/version-badge.mdx'

<VersionBadge version="2.0.0" />

MCP 服务器可以向客户端发出日志消息。客户端可以通过日志处理程序回调来处理这些日志。

## 日志处理程序

在创建客户端时提供 `log_handler` 函数。为了健壮的日志记录，日志消息可以与 Python 的标准 `logging` 模块集成。

```python
import logging
from fastmcp import Client
from fastmcp.client.logging import LogMessage

# 在真实应用中，您可能会在主入口点配置此项
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)

# 为使用客户端的模块获取日志记录器
logger = logging.getLogger(__name__)

# 此映射对于将 MCP 级别字符串转换为 Python 级别很有用
LOGGING_LEVEL_MAP = logging.getLevelNamesMapping()

async def log_handler(message: LogMessage):
    """
    处理来自 MCP 服务器的传入日志并将其转发
    到标准 Python 日志记录系统。
    """
    msg = message.data.get('msg')
    extra = message.data.get('extra')

    # 将 MCP 日志级别转换为 Python 日志级别
    level = LOGGING_LEVEL_MAP.get(message.level.upper(), logging.INFO)

    # 使用标准日志记录库记录消息
    logger.log(level, msg, extra=extra)


client = Client(
    "my_mcp_server.py",
    log_handler=log_handler,
)
```

## 处理结构化日志

`message.data` 属性是一个包含来自服务器的日志载荷的字典。这允许结构化日志记录，使您能够接收丰富的上下文信息。

该字典包含两个键：
- `msg`：字符串日志消息。
- `extra`：包含从服务器发送的任何额外数据的字典。

即使在通过 FastMCP 代理转发日志时，这种结构也得以保持，使其成为调试复杂多服务器应用程序的强大工具。

### 处理程序参数

每次接收到日志消息时都会调用 `log_handler`。它接收一个 `LogMessage` 对象：

<Card icon="code" title="日志处理程序参数">
<ResponseField name="LogMessage" type="Log Message Object">
  <Expandable title="attributes">
    <ResponseField name="level" type='Literal["debug", "info", "notice", "warning", "error", "critical", "alert", "emergency"]'>
      日志级别
    </ResponseField>

    <ResponseField name="logger" type="str | None">
      日志记录器名称（可选，可能为 None）
    </ResponseField>

    <ResponseField name="data" type="dict">
      日志载荷，包含 `msg` 和 `extra` 键。
    </ResponseField>
  </Expandable>
</ResponseField>
</Card>

```python
async def detailed_log_handler(message: LogMessage):
    msg = message.data.get('msg')
    extra = message.data.get('extra')

    if message.level == "error":
        print(f"错误: {msg} | 详情: {extra}")
    elif message.level == "warning":
        print(f"警告: {msg} | 详情: {extra}")
    else:
        print(f"{message.level.upper()}: {msg}")
```

## 默认日志处理

如果您不提供自定义的 `log_handler`，FastMCP 的默认处理程序会将服务器日志路由到适当的 Python 日志记录级别。MCP 级别映射如下：`notice` → INFO；`alert` 和 `emergency` → CRITICAL。如果服务器包含日志记录器名称，则在消息中加前缀，并通过日志记录 `extra` 参数转发任何 `extra` 数据。

```python
client = Client("my_mcp_server.py")

async with client:
    # 服务器日志以其适当的严重性转发 (DEBUG/INFO/WARNING/ERROR/CRITICAL)
    await client.call_tool("some_tool")
```
