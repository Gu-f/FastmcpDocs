---
title: OAuth 身份验证
sidebarTitle: OAuth
description: 通过 OAuth 2.1 对您的 FastMCP 客户端进行身份验证。
icon: window
tag: NEW
---

import { VersionBadge } from "/snippets/version-badge.mdx"

<VersionBadge version="2.6.0" />

<Tip>
OAuth 身份验证仅适用于基于 HTTP 的传输方式，并需要通过 Web 浏览器进行用户交互。
</Tip>

当您的 FastMCP 客户端需要访问受 OAuth 2.1 保护的 MCP 服务器，且该过程需要用户交互（如登录和授予同意）时，您应该使用授权码流程。FastMCP 提供了 `fastmcp.client.auth.OAuth` 辅助类来简化整个过程。

此流程常用于面向用户的应用程序，其中应用程序代表用户行事。

## 客户端使用


### 默认配置

使用 OAuth 的最简单方法是将字符串 `"oauth"` 传递给 `Client` 或传输实例的 `auth` 参数。FastMCP 将自动配置客户端使用默认设置的 OAuth：

```python {4}
from fastmcp import Client

# 使用默认 OAuth 设置
async with Client("https://fastmcp.cloud/mcp", auth="oauth") as client:
    await client.ping()
```


### `OAuth` 辅助类

要完全配置 OAuth 流程，请使用 `OAuth` 辅助类并将其传递给 `Client` 或传输实例的 `auth` 参数。`OAuth` 管理 OAuth 2.1 授权码授予和 PKCE（代码交换证明密钥）的复杂性以增强安全性，并实现完整的 `httpx.Auth` 接口。

```python {2, 4, 6}
from fastmcp import Client
from fastmcp.client.auth import OAuth

oauth = OAuth(mcp_url="https://fastmcp.cloud/mcp")

async with Client("https://fastmcp.cloud/mcp", auth=oauth) as client:
    await client.ping()
```

#### `OAuth` 参数

- **`mcp_url`** (`str`)：目标 MCP 服务器端点的完整 URL。用于发现 OAuth 服务器元数据
- **`scopes`** (`str | list[str]`，可选)：要请求的 OAuth 作用域。可以是空格分隔的字符串或字符串列表
- **`client_name`** (`str`，可选)：用于动态注册的客户端名称。默认为 `"FastMCP Client"`
- **`token_storage_cache_dir`** (`Path`，可选)：令牌缓存目录。默认为 `~/.fastmcp/oauth-mcp-client-cache/`
- **`additional_client_metadata`** (`dict[str, Any]`，可选)：客户端注册的额外元数据
- **`callback_port`** (`int`，可选)：OAuth 回调服务器的固定端口。如果未指定，则使用随机可用端口


## OAuth 流程

当您使用配置为使用 OAuth 的 FastMCP `Client` 时，将触发 OAuth 流程。

<Steps>
<Step title="令牌检查">
客户端首先检查 `token_storage_cache_dir` 中是否存在目标服务器的有效令牌。如果找到，它将用于验证客户端。
</Step>
<Step title="OAuth 服务器发现">
如果不存在有效令牌，客户端会尝试使用基于 `mcp_url` 的已知 URI（例如 `/.well-known/oauth-authorization-server`）来发现 OAuth 服务器的端点。
</Step>
<Step title="动态客户端注册">
如果 OAuth 服务器支持且客户端尚未注册（或凭据未缓存），客户端将根据 RFC 7591 执行动态客户端注册。
</Step>
<Step title="本地回调服务器">
在可用端口（或通过 `callback_port` 指定的端口）上启动临时本地 HTTP 服务器。该服务器的地址（例如 `http://127.0.0.1:<port>/callback`）作为 OAuth 流程的 `redirect_uri`。
</Step>
<Step title="浏览器交互">
用户的默认 Web 浏览器会自动打开，将他们定向到 OAuth 服务器的授权端点。用户登录并授予（或拒绝）请求的 `scopes`。
</Step>
<Step title="授权码和令牌交换">
批准后，OAuth 服务器将用户的浏览器重定向到本地回调服务器，并带有 `authorization_code`。客户端捕获此代码，并使用 PKCE 增强安全性，与 OAuth 服务器的令牌端点交换 `access_token`（通常还有 `refresh_token`）。
</Step>
<Step title="令牌缓存">
获得的令牌保存到 `token_storage_cache_dir` 供将来使用，无需重复浏览器交互。
</Step> 
<Step title="已验证请求">
访问令牌会自动包含在对 MCP 服务器请求的 `Authorization` 标头中。
</Step>
<Step title="刷新令牌">
如果访问令牌过期，客户端将自动使用刷新令牌获取新的访问令牌。
</Step>
</Steps>

## 令牌管理

### 令牌存储

OAuth 访问令牌会自动缓存在 `~/.fastmcp/oauth-mcp-client-cache/` 中，并在应用程序运行之间保持。文件按 OAuth 服务器的基本 URL 键入。

### 管理缓存

要清除特定服务器的令牌，请实例化 `FileTokenStorage` 实例并调用 `clear` 方法：

```python
from fastmcp.client.auth.oauth import FileTokenStorage

storage = FileTokenStorage(server_url="https://fastmcp.cloud/mcp")
await storage.clear()
```

要清除*所有*服务器的所有令牌，请在 `FileTokenStorage` 类上调用 `clear_all` 方法：

```python
from fastmcp.client.auth.oauth import FileTokenStorage

FileTokenStorage.clear_all()
```
