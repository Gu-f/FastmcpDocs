---
title: client
sidebarTitle: client
---

# `fastmcp.client.client`

## 类

### `ClientSessionState` <sup><a href="https://github.com/jlowin/fastmcp/blob/main/src/fastmcp/client/client.py#L74" target="_blank"><Icon icon="github" style="width: 14px; height: 14px;" /></a></sup>


保存客户端实例的所有会话相关状态。

这允许清晰地分离配置（会被复制）和会话状态（每个新客户端实例都应该是全新的）。


### `Client` <sup><a href="https://github.com/jlowin/fastmcp/blob/main/src/fastmcp/client/client.py#L90" target="_blank"><Icon icon="github" style="width: 14px; height: 14px;" /></a></sup>


MCP 客户端，将连接管理委托给传输实例。

Client 类负责 MCP 协议逻辑，而传输负责连接建立和管理。客户端提供了用于
处理资源、提示、工具和其他 MCP 功能的方法。

此客户端支持可重入上下文管理器（多个并发的
`async with client:` 块），使用引用计数和后台会话
管理。这允许在任何嵌套或并发客户端使用场景中高效复用会话。

MCP SDK 1.10 在 call_tool() 执行期间引入了自动 list_tools() 调用。
这产生了一个竞态条件，即在其他任务等待事件时事件可能被重置，导致死锁。
该问题在代理场景中暴露，但影响任何可重入使用。

解决方案使用引用计数来跟踪活动上下文管理器，
后台任务来管理会话生命周期，事件来协调
任务之间的通信，并确保所有会话状态变更都在锁内发生。
事件仅在需要时创建，从不在锁外重置。

这种设计防止了任务等待被其他任务替换的事件的竞态条件，
确保在并发场景中的可靠协调。

**参数：**
- `transport`: 
连接源规范，可以是\:

    - ClientTransport\: 直接传输实例
    - FastMCP\: 进程内 FastMCP 服务器
    - AnyUrl 或 str\: 要连接的 URL
    - Path\: 本地套接字的文件路径
    - MCPConfig\: MCP 服务器配置
    - dict\: 传输配置
- `roots`: 用于文件系统访问的可选 RootsList 或 RootsHandler
- `sampling_handler`: 用于采样请求的可选处理器
- `log_handler`: 用于日志消息的可选处理器
- `message_handler`: 用于协议消息的可选处理器
- `progress_handler`: 用于进度通知的可选处理器
- `timeout`: 请求的可选超时（秒或 timedelta）
- `init_timeout`: 初始连接的可选超时（秒或 timedelta）。
设置为 0 表示禁用。如果为 None，则使用 FastMCP 全局设置中的值。

**示例：**

```python
# 连接到 FastMCP 服务器
client = Client("http://localhost:8080")

async with client:
    # 列出可用资源
    resources = await client.list_resources()

    # 调用工具
    result = await client.call_tool("my_tool", {"param": "value"})
```


**方法：**

#### `session` <sup><a href="https://github.com/jlowin/fastmcp/blob/main/src/fastmcp/client/client.py#L273" target="_blank"><Icon icon="github" style="width: 14px; height: 14px;" /></a></sup>

```python
session(self) -> ClientSession
```

获取当前活动会话。如果未连接则抛出 RuntimeError。


#### `initialize_result` <sup><a href="https://github.com/jlowin/fastmcp/blob/main/src/fastmcp/client/client.py#L283" target="_blank"><Icon icon="github" style="width: 14px; height: 14px;" /></a></sup>

```python
initialize_result(self) -> mcp.types.InitializeResult
```

获取初始化请求的结果。


#### `set_roots` <sup><a href="https://github.com/jlowin/fastmcp/blob/main/src/fastmcp/client/client.py#L291" target="_blank"><Icon icon="github" style="width: 14px; height: 14px;" /></a></sup>

```python
set_roots(self, roots: RootsList | RootsHandler) -> None
```

设置客户端的根目录。这不会自动调用 `send_roots_list_changed`。


#### `set_sampling_callback` <sup><a href="https://github.com/jlowin/fastmcp/blob/main/src/fastmcp/client/client.py#L295" target="_blank"><Icon icon="github" style="width: 14px; height: 14px;" /></a></sup>

```python
set_sampling_callback(self, sampling_callback: SamplingHandler) -> None
```

设置客户端的采样回调。


#### `set_elicitation_callback` <sup><a href="https://github.com/jlowin/fastmcp/blob/main/src/fastmcp/client/client.py#L301" target="_blank"><Icon icon="github" style="width: 14px; height: 14px;" /></a></sup>

```python
set_elicitation_callback(self, elicitation_callback: ElicitationHandler) -> None
```

设置客户端的引导回调。


#### `is_connected` <sup><a href="https://github.com/jlowin/fastmcp/blob/main/src/fastmcp/client/client.py#L309" target="_blank"><Icon icon="github" style="width: 14px; height: 14px;" /></a></sup>

```python
is_connected(self) -> bool
```

检查客户端当前是否已连接。


#### `new` <sup><a href="https://github.com/jlowin/fastmcp/blob/main/src/fastmcp/client/client.py#L313" target="_blank"><Icon icon="github" style="width: 14px; height: 14px;" /></a></sup>

```python
new(self) -> Client[ClientTransportT]
```

创建一个具有相同配置但全新会话状态的新客户端实例。

这会创建一个具有相同传输、处理器和配置的新客户端，
但没有活动会话。适用于创建不与原始客户端共享状态的独立会话。

**返回值：**
- 一个具有相同配置但断开状态的新客户端实例。


#### `close` <sup><a href="https://github.com/jlowin/fastmcp/blob/main/src/fastmcp/client/client.py#L476" target="_blank"><Icon icon="github" style="width: 14px; height: 14px;" /></a></sup>

```python
close(self)
```

#### `ping` <sup><a href="https://github.com/jlowin/fastmcp/blob/main/src/fastmcp/client/client.py#L482" target="_blank"><Icon icon="github" style="width: 14px; height: 14px;" /></a></sup>

```python
ping(self) -> bool
```

发送一个 ping 请求。


#### `cancel` <sup><a href="https://github.com/jlowin/fastmcp/blob/main/src/fastmcp/client/client.py#L487" target="_blank"><Icon icon="github" style="width: 14px; height: 14px;" /></a></sup>

```python
cancel(self, request_id: str | int, reason: str | None = None) -> None
```

为正在进行的请求发送取消通知。


#### `progress` <sup><a href="https://github.com/jlowin/fastmcp/blob/main/src/fastmcp/client/client.py#L504" target="_blank"><Icon icon="github" style="width: 14px; height: 14px;" /></a></sup>

```python
progress(self, progress_token: str | int, progress: float, total: float | None = None, message: str | None = None) -> None
```

发送进度通知。


#### `set_logging_level` <sup><a href="https://github.com/jlowin/fastmcp/blob/main/src/fastmcp/client/client.py#L516" target="_blank"><Icon icon="github" style="width: 14px; height: 14px;" /></a></sup>

```python
set_logging_level(self, level: mcp.types.LoggingLevel) -> None
```

发送 logging/setLevel 请求。


#### `send_roots_list_changed` <sup><a href="https://github.com/jlowin/fastmcp/blob/main/src/fastmcp/client/client.py#L520" target="_blank"><Icon icon="github" style="width: 14px; height: 14px;" /></a></sup>

```python
send_roots_list_changed(self) -> None
```

发送 roots/list_changed 通知。


#### `list_resources_mcp` <sup><a href="https://github.com/jlowin/fastmcp/blob/main/src/fastmcp/client/client.py#L526" target="_blank"><Icon icon="github" style="width: 14px; height: 14px;" /></a></sup>

```python
list_resources_mcp(self) -> mcp.types.ListResourcesResult
```

发送 resources/list 请求并返回完整的 MCP 协议结果。

**返回值：**
- mcp.types.ListResourcesResult: 来自协议的完整响应对象，
包含资源列表和任何附加元数据。

**抛出异常：**
- `RuntimeError`: 如果在客户端未连接时调用。


#### `list_resources` <sup><a href="https://github.com/jlowin/fastmcp/blob/main/src/fastmcp/client/client.py#L539" target="_blank"><Icon icon="github" style="width: 14px; height: 14px;" /></a></sup>

```python
list_resources(self) -> list[mcp.types.Resource]
```

检索服务器上可用的资源列表。

**返回值：**
- list\[mcp.types.Resource]: 资源对象列表。

**抛出异常：**
- `RuntimeError`: 如果在客户端未连接时调用。


#### `list_resource_templates_mcp` <sup><a href="https://github.com/jlowin/fastmcp/blob/main/src/fastmcp/client/client.py#L551" target="_blank"><Icon icon="github" style="width: 14px; height: 14px;" /></a></sup>

```python
list_resource_templates_mcp(self) -> mcp.types.ListResourceTemplatesResult
```

发送 resources/listResourceTemplates 请求并返回完整的 MCP 协议结果。

**返回值：**
- mcp.types.ListResourceTemplatesResult: 来自协议的完整响应对象，
包含资源模板列表和任何附加元数据。

**抛出异常：**
- `RuntimeError`: 如果在客户端未连接时调用。


#### `list_resource_templates` <sup><a href="https://github.com/jlowin/fastmcp/blob/main/src/fastmcp/client/client.py#L566" target="_blank"><Icon icon="github" style="width: 14px; height: 14px;" /></a></sup>

```python
list_resource_templates(self) -> list[mcp.types.ResourceTemplate]
```

检索服务器上可用的资源模板列表。

**返回值：**
- list\[mcp.types.ResourceTemplate]: ResourceTemplate 对象列表。

**抛出异常：**
- `RuntimeError`: 如果在客户端未连接时调用。


#### `read_resource_mcp` <sup><a href="https://github.com/jlowin/fastmcp/blob/main/src/fastmcp/client/client.py#L580" target="_blank"><Icon icon="github" style="width: 14px; height: 14px;" /></a></sup>

```python
read_resource_mcp(self, uri: AnyUrl | str) -> mcp.types.ReadResourceResult
```

发送 resources/read 请求并返回完整的 MCP 协议结果。

**参数：**
- `uri`: 要读取的资源的 URI。可以是字符串或 AnyUrl 对象。

**返回值：**
- mcp.types.ReadResourceResult: 来自协议的完整响应对象，
包含资源内容和任何附加元数据。

**抛出异常：**
- `RuntimeError`: 如果在客户端未连接时调用。


#### `read_resource` <sup><a href="https://github.com/jlowin/fastmcp/blob/main/src/fastmcp/client/client.py#L600" target="_blank"><Icon icon="github" style="width: 14px; height: 14px;" /></a></sup>

```python
read_resource(self, uri: AnyUrl | str) -> list[mcp.types.TextResourceContents | mcp.types.BlobResourceContents]
```

读取资源或已解析模板的内容。

**参数：**
- `uri`: 要读取的资源的 URI。可以是字符串或 AnyUrl 对象。

**返回值：**
- list\[mcp.types.TextResourceContents | mcp.types.BlobResourceContents]: 内容对象列表，
通常包含文本或二进制数据。

**抛出异常：**
- `RuntimeError`: 如果在客户端未连接时调用。


#### `list_prompts_mcp` <sup><a href="https://github.com/jlowin/fastmcp/blob/main/src/fastmcp/client/client.py#L639" target="_blank"><Icon icon="github" style="width: 14px; height: 14px;" /></a></sup>

```python
list_prompts_mcp(self) -> mcp.types.ListPromptsResult
```

发送 prompts/list 请求并返回完整的 MCP 协议结果。

**返回值：**
- mcp.types.ListPromptsResult: 来自协议的完整响应对象，
包含提示列表和任何附加元数据。

**抛出异常：**
- `RuntimeError`: 如果在客户端未连接时调用。


#### `list_prompts` <sup><a href="https://github.com/jlowin/fastmcp/blob/main/src/fastmcp/client/client.py#L652" target="_blank"><Icon icon="github" style="width: 14px; height: 14px;" /></a></sup>

```python
list_prompts(self) -> list[mcp.types.Prompt]
```

检索服务器上可用的提示列表。

**返回值：**
- list\[mcp.types.Prompt]: Prompt 对象列表。

**抛出异常：**
- `RuntimeError`: 如果在客户端未连接时调用。


#### `get_prompt_mcp` <sup><a href="https://github.com/jlowin/fastmcp/blob/main/src/fastmcp/client/client.py#L665" target="_blank"><Icon icon="github" style="width: 14px; height: 14px;" /></a></sup>

```python
get_prompt_mcp(self, name: str, arguments: dict[str, Any] | None = None) -> mcp.types.GetPromptResult
```

发送 prompts/get 请求并返回完整的 MCP 协议结果。

**参数：**
- `name`: 要检索的提示名称。
- `arguments`: 传递给提示的参数。默认为 None。

**返回值：**
- mcp.types.GetPromptResult: 来自协议的完整响应对象，
包含提示消息和任何附加元数据。

**抛出异常：**
- `RuntimeError`: 如果在客户端未连接时调用。


#### `get_prompt` <sup><a href="https://github.com/jlowin/fastmcp/blob/main/src/fastmcp/client/client.py#L699" target="_blank"><Icon icon="github" style="width: 14px; height: 14px;" /></a></sup>

```python
get_prompt(self, name: str, arguments: dict[str, Any] | None = None) -> mcp.types.GetPromptResult
```

从服务器检索已渲染的提示消息列表。

**参数：**
- `name`: 要检索的提示名称。
- `arguments`: 传递给提示的参数。默认为 None。

**返回值：**
- mcp.types.GetPromptResult: 来自协议的完整响应对象，
包含提示消息和任何附加元数据。

**抛出异常：**
- `RuntimeError`: 如果在客户端未连接时调用。


#### `complete_mcp` <sup><a href="https://github.com/jlowin/fastmcp/blob/main/src/fastmcp/client/client.py#L720" target="_blank"><Icon icon="github" style="width: 14px; height: 14px;" /></a></sup>

```python
complete_mcp(self, ref: mcp.types.ResourceReference | mcp.types.PromptReference, argument: dict[str, str]) -> mcp.types.CompleteResult
```

发送完成请求并返回完整的 MCP 协议结果。

**参数：**
- `ref`: 要完成的引用。
- `argument`: 传递给完成请求的参数。

**返回值：**
- mcp.types.CompleteResult: 来自协议的完整响应对象，
包含完成结果和任何附加元数据。

**抛出异常：**
- `RuntimeError`: 如果在客户端未连接时调用。


#### `complete` <sup><a href="https://github.com/jlowin/fastmcp/blob/main/src/fastmcp/client/client.py#L741" target="_blank"><Icon icon="github" style="width: 14px; height: 14px;" /></a></sup>

```python
complete(self, ref: mcp.types.ResourceReference | mcp.types.PromptReference, argument: dict[str, str]) -> mcp.types.Completion
```

向服务器发送完成请求。

**参数：**
- `ref`: 要完成的引用。
- `argument`: 传递给完成请求的参数。

**返回值：**
- mcp.types.Completion: 完成对象。

**抛出异常：**
- `RuntimeError`: 如果在客户端未连接时调用。


#### `list_tools_mcp` <sup><a href="https://github.com/jlowin/fastmcp/blob/main/src/fastmcp/client/client.py#L763" target="_blank"><Icon icon="github" style="width: 14px; height: 14px;" /></a></sup>

```python
list_tools_mcp(self) -> mcp.types.ListToolsResult
```

发送 tools/list 请求并返回完整的 MCP 协议结果。

**返回值：**
- mcp.types.ListToolsResult: 来自协议的完整响应对象，
包含工具列表和任何附加元数据。

**抛出异常：**
- `RuntimeError`: 如果在客户端未连接时调用。


#### `list_tools` <sup><a href="https://github.com/jlowin/fastmcp/blob/main/src/fastmcp/client/client.py#L776" target="_blank"><Icon icon="github" style="width: 14px; height: 14px;" /></a></sup>

```python
list_tools(self) -> list[mcp.types.Tool]
```

检索服务器上可用的工具列表。

**返回值：**
- list\[mcp.types.Tool]: 工具对象列表。

**抛出异常：**
- `RuntimeError`: 如果在客户端未连接时调用。


#### `call_tool_mcp` <sup><a href="https://github.com/jlowin/fastmcp/blob/main/src/fastmcp/client/client.py#L790" target="_blank"><Icon icon="github" style="width: 14px; height: 14px;" /></a></sup>

```python
call_tool_mcp(self, name: str, arguments: dict[str, Any], progress_handler: ProgressHandler | None = None, timeout: datetime.timedelta | float | int | None = None) -> mcp.types.CallToolResult
```

发送 tools/call 请求并返回完整的 MCP 协议结果。

此方法返回原始的 CallToolResult 对象，其中包括 isError 标志
和其他元数据。如果工具调用导致错误，它不会抛出异常。

**参数：**
- `name`: 要调用的工具名称。
- `arguments`: 传递给工具的参数。
- `timeout`: 工具调用的超时时间。默认为 None。
- `progress_handler`: 用于工具调用的进度处理器。默认为 None。

**返回值：**
- mcp.types.CallToolResult: 来自协议的完整响应对象，
包含工具结果和任何附加元数据。

**抛出异常：**
- `RuntimeError`: 如果在客户端未连接时调用。


#### `call_tool` <sup><a href="https://github.com/jlowin/fastmcp/blob/main/src/fastmcp/client/client.py#L826" target="_blank"><Icon icon="github" style="width: 14px; height: 14px;" /></a></sup>

```python
call_tool(self, name: str, arguments: dict[str, Any] | None = None, timeout: datetime.timedelta | float | int | None = None, progress_handler: ProgressHandler | None = None, raise_on_error: bool = True) -> CallToolResult
```

在服务器上调用工具。

与 call_tool_mcp 不同，如果工具调用导致错误，此方法会抛出 ToolError。

**参数：**
- `name`: 要调用的工具名称。
- `arguments`: 传递给工具的参数。默认为 None。
- `timeout`: 工具调用的超时时间。默认为 None。
- `progress_handler`: 用于工具调用的进度处理器。默认为 None。

**返回值：**
- 
工具返回的内容。如果工具返回结构化
输出，它们会作为数据类（如果有输出模式可用）
或字典返回；否则，返回内容块列表。
注意：要同时接收结构化和非结构化输出，
请使用 call_tool_mcp 并访问原始结果对象。

**抛出异常：**
- `ToolError`: 如果工具调用导致错误。
- `RuntimeError`: 如果在客户端未连接时调用。


### `CallToolResult` <sup><a href="https://github.com/jlowin/fastmcp/blob/main/src/fastmcp/client/client.py#L898" target="_blank"><Icon icon="github" style="width: 14px; height: 14px;" /></a></sup>
