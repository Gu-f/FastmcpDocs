---
title: 进度报告
sidebarTitle: 进度
description: 通过 MCP 上下文向客户端更新长时间运行操作的进度。
icon: chart-line
---

import { VersionBadge } from '/snippets/version-badge.mdx'

进度报告允许 MCP 工具向客户端通知长时间运行操作的进度。这使客户端能够显示进度指示器，并在耗时任务期间提供更好的用户体验。

## 为什么使用进度报告？

进度报告对以下方面很有价值：

- **用户体验**：让用户了解长时间运行的操作
- **进度指示器**：使客户端能够显示进度条或百分比
- **防止超时**：证明操作正在积极进行
- **调试**：跟踪执行进度以进行性能分析

### 基本用法

使用 `ctx.report_progress()` 向客户端发送进度更新：

```python {14, 21}
from fastmcp import FastMCP, Context
import asyncio

mcp = FastMCP("ProgressDemo")

@mcp.tool
async def process_items(items: list[str], ctx: Context) -> dict:
    """通过进度更新处理项目列表。"""
    total = len(items)
    results = []
    
    for i, item in enumerate(items):
        # 在处理每个项目时报告进度
        await ctx.report_progress(progress=i, total=total)
        
        # 模拟处理时间
        await asyncio.sleep(0.1)
        results.append(item.upper())
    
    # 报告 100% 完成
    await ctx.report_progress(progress=total, total=total)
    
    return {"processed": len(results), "results": results}
```

## 方法签名

<Card icon="code" title="上下文进度方法">
<ResponseField name="ctx.report_progress" type="异步方法">
  为长时间运行的操作向客户端报告进度
  
  <Expandable title="参数">
    <ResponseField name="progress" type="float">
      当前进度值（例如，24、0.75、1500）
    </ResponseField>
    
    <ResponseField name="total" type="float | None" default="None">
      可选的总值（例如，100、1.0、2000）。提供时，客户端可能将此解释为启用百分比计算。
    </ResponseField>
  </Expandable>
</ResponseField>
</Card>

## 进度模式

### 基于百分比的进度

将进度报告为百分比（0-100）：

```python {13-14}
@mcp.tool
async def download_file(url: str, ctx: Context) -> str:
    """通过百分比进度下载文件。"""
    total_size = 1000  # KB
    downloaded = 0
    
    while downloaded < total_size:
        # 下载块
        chunk_size = min(50, total_size - downloaded)
        downloaded += chunk_size
        
        # 报告百分比进度
        percentage = (downloaded / total_size) * 100
        await ctx.report_progress(progress=percentage, total=100)
        
        await asyncio.sleep(0.1)  # 模拟下载时间
    
    return f"从 {url} 下载文件完成"
```

### 绝对进度

使用绝对值报告进度：

```python {10}
@mcp.tool
async def backup_database(ctx: Context) -> str:
    """通过绝对进度备份数据库表。"""
    tables = ["users", "orders", "products", "inventory", "logs"]
    
    for i, table in enumerate(tables):
        await ctx.info(f"正在备份表：{table}")
        
        # 报告绝对进度
        await ctx.report_progress(progress=i + 1, total=len(tables))
        
        # 模拟备份时间
        await asyncio.sleep(0.5)
    
    return "数据库备份完成"
```

### 不确定进度

对于终点未知的操作，在没有已知总数的情况下报告进度：

```python {11}
@mcp.tool
async def scan_directory(directory: str, ctx: Context) -> dict:
    """通过不确定进度扫描目录。"""
    files_found = 0
    
    # 模拟目录扫描
    for i in range(10):  # 未知文件数量
        files_found += 1
        
        # 对于不确定操作，报告进度时不提供总数
        await ctx.report_progress(progress=files_found)
        
        await asyncio.sleep(0.2)
    
    return {"files_found": files_found, "directory": directory}
```

### 多阶段操作

将复杂操作分解为阶段，每个阶段都有进度：

```python
@mcp.tool
async def data_migration(source: str, destination: str, ctx: Context) -> str:
    """通过多阶段进度报告迁移数据。"""
    
    # 阶段 1：验证（0-25%）
    await ctx.info("验证源数据")
    for i in range(5):
        await ctx.report_progress(progress=i * 5, total=100)
        await asyncio.sleep(0.1)
    
    # 阶段 2：导出（25-60%）
    await ctx.info("从源导出数据")
    for i in range(7):
        progress = 25 + (i * 5)
        await ctx.report_progress(progress=progress, total=100)
        await asyncio.sleep(0.1)
    
    # 阶段 3：转换（60-80%）
    await ctx.info("转换数据格式")
    for i in range(4):
        progress = 60 + (i * 5)
        await ctx.report_progress(progress=progress, total=100)
        await asyncio.sleep(0.1)
    
    # 阶段 4：导入（80-100%）
    await ctx.info("导入到目标")
    for i in range(4):
        progress = 80 + (i * 5)
        await ctx.report_progress(progress=progress, total=100)
        await asyncio.sleep(0.1)
    
    # 最终完成
    await ctx.report_progress(progress=100, total=100)
    
    return f"从 {source} 到 {destination} 的迁移完成"
```


## 客户端要求

进度报告需要客户端支持进度处理：

- 客户端必须在初始请求中发送 `progressToken` 以接收进度更新
- 如果未提供进度令牌，进度调用将不会产生任何效果（不会报错）
- 有关实现客户端进度处理的详细信息，请参阅[客户端进度](/zh/clients/progress)
